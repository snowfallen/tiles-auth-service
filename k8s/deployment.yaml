# Auth Service Deployment

apiVersion: apps/v1
kind: Deployment
metadata:
  name: auth-service
  namespace: tiles-infra
  labels:
    app: auth-service
    component: backend
spec:
  # Multiple replicas можливі (stateless service)
  replicas: 2

  # RollingUpdate strategy (zero-downtime deploys)
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1        # Max 1 extra pod during update
      maxUnavailable: 0  # Always keep at least 1 pod running

  selector:
    matchLabels:
      app: auth-service

  template:
    metadata:
      labels:
        app: auth-service
        component: backend
      annotations:
        # Prometheus scraping (optional, для metrics)
        prometheus.io/scrape: "true"
        prometheus.io/port: "8084"
        prometheus.io/path: "/actuator/prometheus"
    spec:
      # Init container - wait для PostgreSQL
      initContainers:
        - name: wait-for-postgres
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              echo "Waiting for PostgreSQL..."
              until nc -z auth-postgres.tiles-infra.svc.cluster.local 5432; do
                echo "PostgreSQL not ready yet..."
                sleep 2
              done
              echo "PostgreSQL is ready!"

        - name: wait-for-redis
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              echo "Waiting for Redis..."
              until nc -z auth-redis.tiles-infra.svc.cluster.local 6379; do
                echo "Redis not ready yet..."
                sleep 2
              done
              echo "Redis is ready!"

      containers:
        - name: auth-service
          image: tiles/auth-service:1.0.0
          imagePullPolicy: IfNotPresent  # Kind: local images

          ports:
            - containerPort: 8084
              name: http
              protocol: TCP

          # Environment variables
          env:
            # Spring profiles
            - name: SPRING_PROFILES_ACTIVE
              value: "dev"

            # PostgreSQL connection
            - name: SPRING_DATASOURCE_URL
              value: jdbc:postgresql://auth-postgres.tiles-infra.svc.cluster.local:5432/auth_db

            - name: SPRING_DATASOURCE_USERNAME
              valueFrom:
                configMapKeyRef:
                  name: auth-postgres-config
                  key: POSTGRES_USER

            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: auth-postgres-secret
                  key: POSTGRES_PASSWORD

            # Redis connection
            - name: SPRING_DATA_REDIS_HOST
              value: auth-redis.tiles-infra.svc.cluster.local

            - name: SPRING_DATA_REDIS_PORT
              value: "6379"

            - name: REDIS_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: auth-redis-secret
                  key: REDIS_PASSWORD

            # JWT configuration
            - name: JWT_SECRET
              valueFrom:
                secretKeyRef:
                  name: jwt-secret  # Створимо окремий Secret
                  key: JWT_SECRET

            # Config Server
            - name: SPRING_CLOUD_CONFIG_URI
              value: http://config-service.tiles-infra.svc.cluster.local:8888

          # Resource limits
          resources:
            requests:
              memory: "512Mi"
              cpu: "250m"
            limits:
              memory: "1Gi"
              cpu: "1000m"

          # Liveness probe
          livenessProbe:
            httpGet:
              path: /actuator/health/liveness
              port: 8084
            initialDelaySeconds: 60  # Longer для Liquibase migrations
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3

          # Readiness probe
          readinessProbe:
            httpGet:
              path: /actuator/health/readiness
              port: 8084
            initialDelaySeconds: 30
            periodSeconds: 5
            timeoutSeconds: 3
            failureThreshold: 3

          # Startup probe (для slow startup)
          startupProbe:
            httpGet:
              path: /actuator/health/liveness
              port: 8084
            initialDelaySeconds: 0
            periodSeconds: 5
            timeoutSeconds: 3
            failureThreshold: 30  # 30 * 5s = 150s max startup time

---
# Auth Service Service

apiVersion: v1
kind: Service
metadata:
  name: auth-service
  namespace: tiles-infra
  labels:
    app: auth-service
    component: backend
spec:
  type: ClusterIP

  selector:
    app: auth-service

  ports:
    - port: 8084
      targetPort: 8084
      protocol: TCP
      name: http

  # Session affinity НЕ потрібна (stateless JWT auth)
  sessionAffinity: None
